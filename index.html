<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pacientes + Inventario + Flujo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    input[type=file]{display:none}
    dialog[open]{display:block}
    .tab-active{background:#111827;color:white}
    .chip{font-size:.75rem;padding:.15rem .5rem;border-radius:9999px;background:#eef2ff;color:#3730a3}
  </style>
</head>
<body class="bg-gray-50 text-gray-900">
  <!-- NAV -->
  <nav class="bg-white border-b sticky top-0 z-10">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-2xl">‚òÅÔ∏è</span>
        <h1 class="text-xl font-semibold">Consultorio ‚Äî Mini Suite</h1>
      </div>
      <div class="inline-flex rounded-xl overflow-hidden border">
        <button id="tabPatients"   class="px-3 py-2 hover:bg-gray-100 tab-active">Pacientes</button>
        <button id="tabInventory"  class="px-3 py-2 hover:bg-gray-100">Inventario</button>
        <button id="tabCashflow"   class="px-3 py-2 hover:bg-gray-100">Ingresos/Gastos</button>
      </div>
    </div>
  </nav>

  <main class="max-w-6xl mx-auto px-4 py-6">
    <!-- ========== PACIENTES (tu m√≥dulo, conectado a GAS) ========== -->
    <section id="patientsView">
      <div class="mb-4 grid grid-cols-1 md:grid-cols-6 gap-3">
        <input id="search" class="md:col-span-4 px-3 py-2 rounded-xl border" placeholder="Buscar por nombre, documento o tel√©fono" />
        <button id="btnClear"  type="button" class="px-3 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Limpiar</button>
        <div class="md:justify-self-end text-sm text-gray-500" id="netState"></div>
      </div>

      <div class="flex items-center gap-2 mb-3">
        <button id="btnAdd"    type="button" class="px-3 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Nuevo paciente</button>
        <button id="btnReload" type="button" class="px-3 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Actualizar</button>
      </div>

      <div id="list" class="grid gap-3"></div>

      <dialog id="patientDialog" class="rounded-2xl p-0 w-full max-w-2xl">
        <form id="patientForm" method="dialog" class="bg-white rounded-2xl shadow p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
          <h2 class="md:col-span-2 text-xl font-semibold"><span id="dialogTitle">Nuevo paciente</span></h2>
          <input type="hidden" id="p_id" />
          <div><label class="block text-sm text-gray-600">Nombre *</label><input id="p_full_name" required class="mt-1 px-3 py-2 rounded-xl border w-full" /></div>
          <div><label class="block text-sm text-gray-600">Documento</label><input id="p_document_id" class="mt-1 px-3 py-2 rounded-xl border w-full" /></div>
          <div><label class="block text-sm text-gray-600">Tel√©fono</label><input id="p_phone" class="mt-1 px-3 py-2 rounded-xl border w-full" /></div>
          <div><label class="block text-sm text-gray-600">Email</label><input id="p_email" type="email" class="mt-1 px-3 py-2 rounded-xl border w-full" /></div>
          <div><label class="block text-sm text-gray-600">Fecha de nacimiento</label><input id="p_birthdate" type="date" class="mt-1 px-3 py-2 rounded-xl border w-full" /></div>
          <div class="md:col-span-2"><label class="block text-sm text-gray-600">Direcci√≥n</label><input id="p_address" class="mt-1 px-3 py-2 rounded-xl border w-full" /></div>
          <div class="md:col-span-2"><label class="block text-sm text-gray-600">Notas</label><textarea id="p_notes" rows="3" class="mt-1 px-3 py-2 rounded-xl border w-full"></textarea></div>
          <div class="md:col-span-2 flex items-center gap-2 justify-end">
            <button type="button" id="btnCancel" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Cancelar</button>
            <button type="submit" id="btnSavePatient" class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Guardar</button>
          </div>
        </form>
      </dialog>

      <section id="detail" class="hidden"></section>
    </section>

    <!-- ========== INVENTARIO (localStorage) ========== -->
    <section id="inventoryView" class="hidden">
  <!-- Controles -->
  <div class="grid gap-3 md:grid-cols-12 mb-4">
    <input id="invSearch" class="md:col-span-5 px-3 py-2 rounded-xl border" placeholder="Buscar por nombre o categor√≠a" />
    <select id="invCatFilter" class="md:col-span-3 px-3 py-2 rounded-xl border">
      <option value="">Todas las categor√≠as</option>
    </select>
    <div class="md:col-span-4 flex gap-2 justify-end">
      <button id="btnAddProduct" class="px-3 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Nuevo producto</button>
      <button id="btnIn"  class="px-3 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Ingreso</button>
      <button id="btnOut" class="px-3 py-2 rounded-xl bg-amber-600 text-white hover:bg-amber-700">Salida</button>
    </div>
  </div>

  <!-- Resumen -->
  <div class="grid gap-4 md:grid-cols-3 mb-4">
    <div class="bg-white rounded-2xl shadow p-5"><div class="text-sm text-gray-500">SKU</div><div id="cardSku" class="text-2xl font-bold">‚Äî</div></div>
    <div class="bg-white rounded-2xl shadow p-5"><div class="text-sm text-gray-500">Unidades totales</div><div id="cardUnits" class="text-2xl font-bold">‚Äî</div></div>
    <div class="bg-white rounded-2xl shadow p-5"><div class="text-sm text-gray-500">Costo total</div><div id="cardCost" class="text-2xl font-bold">‚Äî</div></div>
  </div>

  <!-- Tabla -->
  <div class="bg-white rounded-2xl shadow p-5">
    <div id="invList" class="grid gap-2"></div>
  </div>

  <!-- Dialog producto -->
  <dialog id="invProdDialog" class="rounded-2xl p-0 w-full max-w-xl">
    <form id="invProdForm" method="dialog" class="bg-white rounded-2xl shadow p-6 grid gap-3">
      <h2 class="text-xl font-semibold">Producto</h2>
      <input type="hidden" id="prod_id" />
      <div><label class="block text-sm text-gray-600">Nombre *</label><input id="prod_name" class="mt-1 px-3 py-2 rounded-xl border w-full" required /></div>
      <div><label class="block text-sm text-gray-600">Categor√≠a *</label><input id="prod_cat" class="mt-1 px-3 py-2 rounded-xl border w-full" required placeholder="insumos, medicamentos, equipos..." /></div>
      <div class="flex justify-end gap-2">
        <button type="button" id="btnInvProdCancel" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Cancelar</button>
        <button class="px-4 py-2 rounded-xl bg-blue-600 text-white hover:bg-blue-700">Guardar</button>
      </div>
    </form>
  </dialog>

  <!-- Dialog movimiento (nueva factura compra/venta) -->
  <dialog id="invMoveDialog" class="rounded-2xl p-0 w-full max-w-xl">
    <form id="invMoveForm" method="dialog" class="bg-white rounded-2xl shadow p-6 grid gap-3">
      <h2 id="invMoveTitle" class="text-xl font-semibold">Documento</h2>
      <div class="grid md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-gray-600">Tipo</label>
          <input id="doc_type" class="px-3 py-2 rounded-xl border w-full bg-gray-50" readonly />
        </div>
        <div>
          <label class="block text-sm text-gray-600">Nro.</label>
          <input id="doc_no" class="px-3 py-2 rounded-xl border w-full bg-gray-50" readonly />
        </div>
      </div>
      <div class="grid md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-gray-600">Fecha *</label>
          <input id="doc_date" type="date" class="px-3 py-2 rounded-xl border w-full" required />
        </div>
        <div>
          <label class="block text-sm text-gray-600">Tercero</label>
          <input id="doc_party" class="px-3 py-2 rounded-xl border w-full" placeholder="Proveedor / Cliente" />
        </div>
      </div>
      <div>
        <label class="block text-sm text-gray-600">Producto *</label>
        <select id="mv_product" class="mt-1 px-3 py-2 rounded-xl border w-full" required></select>
      </div>
      <div class="grid md:grid-cols-2 gap-3">
        <div><label class="block text-sm text-gray-600">Cantidad *</label><input id="mv_qty" type="number" min="1" step="1" class="mt-1 px-3 py-2 rounded-xl border w-full" required /></div>
        <div id="wrapCost"><label class="block text-sm text-gray-600">Precio compra (unidad) *</label><input id="mv_cost" type="number" min="0" step="0.01" class="mt-1 px-3 py-2 rounded-xl border w-full" /></div>
      </div>
      <div>
        <label class="block text-sm text-gray-600">Notas</label>
        <textarea id="doc_notes" rows="2" class="px-3 py-2 rounded-xl border w-full"></textarea>
      </div>
      <div class="flex justify-end gap-2">
        <button type="button" id="btnInvMoveCancel" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Cancelar</button>
        <button class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Guardar</button>
      </div>
      <p class="text-xs text-gray-500">La salida descuenta stock con <b>costo promedio</b>.</p>
    </form>
  </dialog>

  <!-- Dialog historial por producto -->
  <dialog id="historyDialog" class="rounded-2xl p-0 w-full max-w-3xl">
    <div class="bg-white rounded-2xl shadow p-6">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-xl font-semibold">Historial ‚Äî <span id="histProdName"></span></h2>
        <div class="flex gap-2">
          <button id="btnHistClose" class="px-3 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Cerrar</button>
        </div>
      </div>
      <div id="histList" class="grid gap-2"></div>
    </div>
  </dialog>
</section>

    <!-- ========== INGRESOS / GASTOS (localStorage) ========== -->
    <section id="cashflowView" class="hidden">
      <div class="grid gap-4 md:grid-cols-3 mb-4">
        <div class="bg-white rounded-2xl shadow p-5"><div class="text-sm text-gray-500">Ingresos</div><div id="cfIncome" class="text-2xl font-bold">‚Äî</div></div>
        <div class="bg-white rounded-2xl shadow p-5"><div class="text-sm text-gray-500">Gastos</div><div id="cfExpense" class="text-2xl font-bold">‚Äî</div></div>
        <div class="bg-white rounded-2xl shadow p-5"><div class="text-sm text-gray-500">Balance</div><div id="cfBalance" class="text-2xl font-bold">‚Äî</div></div>
      </div>

      <div class="grid gap-3 md:grid-cols-12 mb-3">
        <input id="cfSearch" class="md:col-span-6 px-3 py-2 rounded-xl border" placeholder="Buscar (concepto, categor√≠a, m√©todo)" />
        <select id="cfType" class="md:col-span-2 px-3 py-2 rounded-xl border">
          <option value="">Tipo: todos</option>
          <option value="ingreso">Ingreso</option>
          <option value="gasto">Gasto</option>
        </select>
        <input id="cfFrom" type="date" class="md:col-span-2 px-3 py-2 rounded-xl border" />
        <input id="cfTo"   type="date" class="md:col-span-2 px-3 py-2 rounded-xl border" />
      </div>

      <div class="flex items-center gap-2 mb-3">
        <button id="btnCfAdd" class="px-3 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Agregar mov.</button>
        <button id="btnCfClear" class="px-3 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Limpiar filtros</button>
      </div>

      <div class="bg-white rounded-2xl shadow p-5" id="cfList"></div>

      <!-- Dialog CF -->
      <dialog id="cfDialog" class="rounded-2xl p-0 w-full max-w-2xl">
        <form id="cfForm" method="dialog" class="bg-white rounded-2xl shadow p-6 grid grid-cols-1 md:grid-cols-2 gap-4">
          <h2 class="md:col-span-2 text-xl font-semibold"><span id="cfDialogTitle">Nuevo movimiento</span></h2>
          <input type="hidden" id="cf_id" />
          <div><label class="block text-sm text-gray-600">Fecha *</label><input id="cf_date" type="date" required class="mt-1 px-3 py-2 rounded-xl border w-full" /></div>
          <div><label class="block text-sm text-gray-600">Tipo *</label>
            <select id="cf_type" required class="mt-1 px-3 py-2 rounded-xl border w-full"><option value="ingreso">Ingreso</option><option value="gasto">Gasto</option></select>
          </div>
          <div><label class="block text-sm text-gray-600">Categor√≠a *</label><input id="cf_category" required class="mt-1 px-3 py-2 rounded-xl border w-full" placeholder="consultas, arriendo, insumos..." /></div>
          <div><label class="block text-sm text-gray-600">Monto *</label><input id="cf_amount" type="number" step="0.01" required class="mt-1 px-3 py-2 rounded-xl border w-full" /></div>
          <div class="md:col-span-2"><label class="block text-sm text-gray-600">Concepto *</label><input id="cf_concept" required class="mt-1 px-3 py-2 rounded-xl border w-full" placeholder="Descripci√≥n breve" /></div>
          <div class="md:col-span-2"><label class="block text-sm text-gray-600">M√©todo</label><input id="cf_method" class="mt-1 px-3 py-2 rounded-xl border w-full" placeholder="efectivo, transferencia..." /></div>
          <div class="md:col-span-2"><label class="block text-sm text-gray-600">Notas</label><textarea id="cf_notes" rows="3" class="mt-1 px-3 py-2 rounded-xl border w-full"></textarea></div>
          <div class="md:col-span-2 flex items-center gap-2 justify-end">
            <button type="button" id="btnCfCancel" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300">Cancelar</button>
            <button class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Guardar</button>
          </div>
        </form>
      </dialog>
    </section>
  </main>

  <footer class="text-center text-xs text-gray-500 py-6">Pacientes usa Apps Script; Inventario y Flujo se guardan en tu navegador (localStorage).</footer>

  <!-- ========= SCRIPT PRINCIPAL ========= -->
  <script>
  /* ====== PACIENTES (tu backend) ====== */
  const API_URL = 'https://script.google.com/macros/s/AKfycbxxL7Sau_wC4Vg5-DLzK0y41EjlR6S1hgWEywnLIbUCSKlAoKJQY5doeAchSElQWulpcg/exec';
  const $ = s => document.querySelector(s);
  const show = (el,flag)=> el.classList.toggle('hidden', !flag);
  const netState = $('#netState'); const showNet = m => netState.textContent = m || '';
  if(!HTMLDialogElement.prototype.showModal){ for(const d of document.querySelectorAll('dialog')){ d.showModal = ()=> d.setAttribute('open',''); d.close = ()=> d.removeAttribute('open'); } }

  async function apiGet(params){
    const url = new URL(API_URL); Object.entries(params||{}).forEach(([k,v])=> url.searchParams.set(k, v));
    const res = await fetch(url.toString()); const txt = await res.text(); try { return JSON.parse(txt); } catch { return []; }
  }
  async function apiPost(body){
    const res = await fetch(API_URL, { method:'POST', body: JSON.stringify(body) });
    const txt = await res.text(); try { return JSON.parse(txt); } catch { return { ok:true, raw: txt }; }
  }

  // Estado Pacientes
  let PSTATE = { patients: [], query:'' };

  function humanDate(d){ return d ? new Date(d).toISOString().slice(0,10) : '‚Äî'; }
  function renderPatients(){
    const listEl = $('#list'), detailEl = $('#detail');
    detailEl.classList.add('hidden'); listEl.innerHTML = '';
    const q = (PSTATE.query||'').toLowerCase();
    const rows = PSTATE.patients.filter(p=>(`${p.nombre||''} ${p.documento||''} ${p.telefono||''}`).toLowerCase().includes(q));
    if(!rows.length){ listEl.innerHTML = '<div class="text-gray-500">No hay pacientes.</div>'; return; }
    for(const p of rows){
      const div = document.createElement('div');
      div.className='bg-white rounded-2xl shadow p-4 flex items-center justify-between';
      div.innerHTML = `
        <div>
          <button class="text-lg font-semibold hover:underline" data-open="${p.id}">${p.nombre}</button>
          <div class="text-sm text-gray-500">Doc: ${p.documento||'‚Äî'} ¬∑ Tel: ${p.telefono||'‚Äî'} ¬∑ Reg: ${humanDate(p.fecha_creacion)}</div>
        </div>
        <div class="flex items-center gap-2">
          <button class="px-3 py-2 rounded-xl bg-amber-500 text-white hover:bg-amber-600" data-edit="${p.id}">Editar</button>
          <button class="px-3 py-2 rounded-xl bg-red-600 text-white hover:bg-red-700" data-del="${p.id}">Eliminar</button>
        </div>`;
      listEl.appendChild(div);
    }
    listEl.querySelectorAll('[data-open]').forEach(b=> b.onclick = ()=> openPatientDetail(b.dataset.open));
    listEl.querySelectorAll('[data-edit]').forEach(b=> b.onclick = ()=> openPatientForm(b.dataset.edit));
    listEl.querySelectorAll('[data-del]').forEach(b=> b.onclick = ()=> deletePatient(b.dataset.del));
  }

  async function loadPatients(){ try{ showNet('Cargando...'); const data = await apiGet({ mode:'patients' }); PSTATE.patients = Array.isArray(data)?data:[]; renderPatients(); showNet(''); } catch(e){ $('#list').innerHTML = `<div class='text-red-700 bg-red-50 border border-red-200 rounded-xl p-3'>No se pudo cargar desde Google Sheets.<br><small>${e.message}</small></div>`; showNet('Error'); } }

  function openPatientForm(id){
    const dlg = $('#patientDialog'); $('#patientForm').reset(); $('#dialogTitle').textContent = id ? 'Editar paciente' : 'Nuevo paciente'; $('#p_id').value = id || '';
    if(id){ const p = PSTATE.patients.find(x=> x.id===id); if(p){ $('#p_full_name').value=p.nombre||''; $('#p_document_id').value=p.documento||''; $('#p_phone').value=p.telefono||''; $('#p_email').value=p.email||''; $('#p_birthdate').value=p.fecha_nacimiento||''; $('#p_address').value=p.direccion||''; $('#p_notes').value=p.notas||''; } }
    dlg.showModal();
  }
  $('#btnAdd').onclick = ()=> openPatientForm();
  $('#btnCancel').onclick = ()=> $('#patientDialog').close();
  $('#btnReload').onclick = loadPatients;
  $('#btnClear').onclick = ()=> { $('#search').value=''; PSTATE.query=''; renderPatients(); }
  $('#search').oninput = e=> { PSTATE.query = e.target.value; renderPatients(); }
  $('#patientForm').onsubmit = async (ev)=>{
    ev.preventDefault();
    const id = $('#p_id').value || ('p_' + Date.now().toString(36));
    const payload = { action:'upsert_patient', data:{ id, nombre: $('#p_full_name').value.trim(), documento: $('#p_document_id').value.trim(), telefono: $('#p_phone').value.trim(), email: $('#p_email').value.trim(), fecha_nacimiento: $('#p_birthdate').value || '', direccion: $('#p_address').value.trim(), notas: $('#p_notes').value.trim() } };
    if(!payload.data.nombre){ alert('El nombre es obligatorio.'); return; }
    try{ showNet('Guardando...'); await apiPost(payload); $('#patientDialog').close(); await loadPatients(); showNet('Guardado ‚úì'); setTimeout(()=>showNet(''),1500);}catch(e){ alert('Error guardando: '+e.message); showNet('Error'); }
  };
  async function deletePatient(id){ const p = PSTATE.patients.find(x=> x.id===id); if(!p) return; if(!confirm(`¬øEliminar a "${p.nombre}"?`)) return; try{ showNet('Eliminando...'); await apiPost({ action:'delete_patient', data:{ id } }); await loadPatients(); showNet('Eliminado ‚úì'); setTimeout(()=>showNet(''),1500);}catch(e){ alert('Error: '+e.message); showNet('Error'); } }
  async function openPatientDetail(id){
    const p = PSTATE.patients.find(x=> x.id===id); if(!p) return; const d = $('#detail'); d.classList.remove('hidden');
    d.innerHTML = `
      <div class="bg-white rounded-2xl shadow p-6 mb-4">
        <div class="flex items-start justify-between">
          <div>
            <h2 class="text-2xl font-bold">${p.nombre}</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mt-2 text-sm">
              <div><span class="text-gray-500">Documento:</span> ${p.documento||'‚Äî'}</div>
              <div><span class="text-gray-500">Tel√©fono:</span> ${p.telefono||'‚Äî'}</div>
              <div><span class="text-gray-500">Email:</span> ${p.email||'‚Äî'}</div>
              <div><span class="text-gray-500">Fecha nac.:</span> ${humanDate(p.fecha_nacimiento)}</div>
              <div class="md:col-span-2"><span class="text-gray-500">Direcci√≥n:</span> ${p.direccion||'‚Äî'}</div>
              <div class="md:col-span-2"><span class="text-gray-500">Notas:</span> ${p.notas||'‚Äî'}</div>
            </div>
          </div>
          <div class="space-x-2">
            <button class="px-3 py-2 rounded-xl bg-amber-500 text-white hover:bg-amber-600" id="editPatient">Editar</button>
          </div>
        </div>
      </div>`;
    $('#editPatient').onclick = ()=> openPatientForm(p.id);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
  loadPatients();

  /* ====== INVENTARIO (localStorage, costo promedio) ====== */
  const LS_INV = 'inv_products_v1';
  function loadInv(){ return JSON.parse(localStorage.getItem(LS_INV) || '[]'); }
  function saveInv(arr){ localStorage.setItem(LS_INV, JSON.stringify(arr)); }
  function money(n){ return Number(n||0).toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0}); }

  let INV = loadInv(); // [{id,name,cat,stock,avg_cost,created_at}]

  const invSearch = $('#invSearch'), invCatFilter = $('#invCatFilter'), invList = $('#invList');
  function invCategories(){ return [...new Set(INV.map(p=> p.cat).filter(Boolean))].sort(); }
  function refreshCatFilter(){
    const chosen = invCatFilter.value || '';
    invCatFilter.innerHTML = '<option value="">Todas las categor√≠as</option>' + invCategories().map(c=>`<option ${c===chosen?'selected':''}>${c}</option>`).join('');
  }
  function invSummary(){
    $('#cardSku').textContent   = INV.length;
    const totalUnits = INV.reduce((a,p)=> a + Number(p.stock||0), 0);
    const totalCost  = INV.reduce((a,p)=> a + (Number(p.stock||0)*Number(p.avg_cost||0)), 0);
    $('#cardUnits').textContent = totalUnits.toLocaleString('es-CO');
    $('#cardCost').textContent  = money(totalCost);
  }
  function renderInv(){
    refreshCatFilter(); invSummary();
    const q = (invSearch.value||'').toLowerCase(); const cat = invCatFilter.value||'';
    const rows = INV.filter(p=>{
      const txt = (p.name+' '+(p.cat||'')).toLowerCase();
      const okQ = !q || txt.includes(q);
      const okC = !cat || p.cat === cat;
      return okQ && okC;
    }).sort((a,b)=> a.name.localeCompare(b.name));
    invList.innerHTML = rows.length ? '' : '<div class="text-gray-500">No hay productos.</div>';
    for(const p of rows){
      const div = document.createElement('div');
      div.className = 'border rounded-2xl p-4 flex items-center justify-between';
      div.innerHTML = `
        <div>
          <div class="font-semibold">${p.name} ${p.cat?`<span class="chip">${p.cat}</span>`:''}</div>
          <div class="text-sm text-gray-500">Stock: <b>${p.stock||0}</b> ¬∑ Costo prom.: <b>${money(p.avg_cost||0)}</b></div>
        </div>
        <div class="flex gap-2">
          <button class="px-3 py-2 rounded-xl bg-amber-500 text-white hover:bg-amber-600" data-edit="${p.id}">Editar</button>
          <button class="px-3 py-2 rounded-xl bg-red-600 text-white hover:bg-red-700" data-del="${p.id}">Eliminar</button>
        </div>`;
      invList.appendChild(div);
    }
    invList.querySelectorAll('[data-edit]').forEach(b=> b.onclick = ()=> openProdForm(b.dataset.edit));
    invList.querySelectorAll('[data-del]').forEach(b=> b.onclick = ()=> deleteProd(b.dataset.del));
  }
  function openProdForm(id){
    const dlg = $('#invProdDialog'), f = $('#invProdForm'); f.reset();
    $('#prod_id').value = id||''; const p = INV.find(x=> x.id===id);
    if(p){ $('#prod_name').value=p.name; $('#prod_cat').value=p.cat||''; }
    dlg.showModal();
  }
  $('#btnAddProduct').onclick = ()=> openProdForm();
  $('#btnInvProdCancel').onclick = ()=> $('#invProdDialog').close();
  $('#invProdForm').onsubmit = (e)=>{
    e.preventDefault();
    const id = $('#prod_id').value || ('sku_'+Date.now().toString(36));
    const name = $('#prod_name').value.trim(); const cat = $('#prod_cat').value.trim();
    if(!name || !cat){ alert('Nombre y categor√≠a son obligatorios'); return; }
    const i = INV.findIndex(x=> x.id===id);
    if(i>=0){ INV[i].name=name; INV[i].cat=cat; }
    else { INV.push({ id, name, cat, stock:0, avg_cost:0, created_at:new Date().toISOString() }); }
    saveInv(INV); $('#invProdDialog').close(); renderInv();
  };
  function deleteProd(id){
    const p = INV.find(x=> x.id===id); if(!p) return;
    if(!confirm(`¬øEliminar "${p.name}"?`)) return;
    INV = INV.filter(x=> x.id!==id); saveInv(INV); renderInv();
  }

  // Movimientos
  let MOVE_MODE = 'in'; // in | out
  function openMoveForm(mode){
    MOVE_MODE = mode;
    const dlg = $('#invMoveDialog'); const f = $('#invMoveForm'); f.reset();
    $('#invMoveTitle').textContent = (mode==='in'?'Ingreso de existencias':'Salida de existencias');
    // llena productos
    const sel = $('#mv_product'); sel.innerHTML = INV.map(p=>`<option value="${p.id}">${p.name} ${p.cat?`(${p.cat})`:''}</option>`).join('');
    // costo solo para ingreso
    $('#wrapCost').style.display = (mode==='in') ? 'block' : 'none';
    dlg.showModal();
  }
  $('#btnIn').onclick  = ()=> openMoveForm('in');
  $('#btnOut').onclick = ()=> openMoveForm('out');
  $('#btnInvMoveCancel').onclick = ()=> $('#invMoveDialog').close();

  $('#invMoveForm').onsubmit = (e)=>{
    e.preventDefault();
    const id = $('#mv_product').value; const qty = Number($('#mv_qty').value||0);
    if(!id || qty<=0){ alert('Selecciona producto y cantidad v√°lida'); return; }
    const p = INV.find(x=> x.id===id); if(!p){ alert('Producto no encontrado'); return; }

    if(MOVE_MODE==='in'){
      const cost = Number($('#mv_cost').value||0); if(cost<=0){ alert('Costo unitario inv√°lido'); return; }
      // WAC: nuevo promedio = (stock*prom + qty*cost) / (stock+qty)
      const newQty = Number(p.stock||0) + qty;
      const newAvg = newQty>0 ? ((Number(p.stock||0)*Number(p.avg_cost||0) + qty*cost) / newQty) : cost;
      p.stock = newQty; p.avg_cost = newAvg;
    }else{
      if(qty > Number(p.stock||0)){ alert('No hay stock suficiente'); return; }
      p.stock = Number(p.stock||0) - qty; // costo de salida = p.avg_cost (lo puedes registrar si luego conectamos a contabilidad)
    }
    saveInv(INV); $('#invMoveDialog').close(); renderInv();
  };

  invSearch.oninput = renderInv; invCatFilter.onchange = renderInv;
  renderInv();

  /* ====== INGRESOS/GASTOS (localStorage) ====== */
  const LS_CF = 'cashflow_v1';
  let CF = JSON.parse(localStorage.getItem(LS_CF) || '[]'); // [{id,date,type,category,concept,amount,method,notes}]
  function saveCF(){ localStorage.setItem(LS_CF, JSON.stringify(CF)); }
  const cfList = $('#cfList');
  function cfHuman(n){ return Number(n||0).toLocaleString('es-CO',{style:'currency',currency:'COP',maximumFractionDigits:0}); }
  function renderCF(){
    const q=( $('#cfSearch').value||'' ).toLowerCase(), t=$('#cfType').value||'';
    const f=$('#cfFrom').value? new Date($('#cfFrom').value):null;
    const to=$('#cfTo').value? new Date($('#cfTo').value):null;

    const rows = CF.filter(r=>{
      const txt = `${r.concept||''} ${r.category||''} ${r.method||''}`.toLowerCase();
      const okQ = !q || txt.includes(q);
      const okT = !t || r.type===t;
      const d = r.date ? new Date(r.date+'T00:00:00') : null;
      const okF = !f || (d && d>=f);
      const okTo= !to|| (d && d<=to);
      return okQ && okT && okF && okTo;
    }).sort((a,b)=> String(b.date||'').localeCompare(String(a.date||'')));

    // lista
    cfList.innerHTML = rows.length ? '' : '<div class="text-gray-500">Sin movimientos.</div>';
    for(const r of rows){
      const card = document.createElement('div');
      card.className='border rounded-2xl p-4 flex items-center justify-between';
      card.innerHTML=`
        <div>
          <div class="font-semibold">${r.type==='ingreso'?'üü¢ Ingreso':'üî¥ Gasto'} ‚Äî ${r.concept||'(sin concepto)'} <span class="text-gray-500">¬∑ ${r.category||'‚Äî'}</span></div>
          <div class="text-sm text-gray-500">${r.date||'‚Äî'} ¬∑ ${r.method||'‚Äî'}</div>
          ${r.notes? `<div class="text-sm mt-1">${r.notes}</div>`:''}
        </div>
        <div class="flex items-center gap-2">
          <div class="font-bold ${r.type==='ingreso'?'text-emerald-700':'text-red-700'}">${cfHuman(r.amount)}</div>
          <button class="px-3 py-2 rounded-xl bg-amber-500 text-white hover:bg-amber-600" data-edit="${r.id}">Editar</button>
          <button class="px-3 py-2 rounded-xl bg-red-600 text-white hover:bg-red-700" data-del="${r.id}">Eliminar</button>
        </div>`;
      cfList.appendChild(card);
    }
    cfList.querySelectorAll('[data-edit]').forEach(b=> b.onclick = ()=> openCfForm(b.dataset.edit));
    cfList.querySelectorAll('[data-del]').forEach(b=> b.onclick = ()=> deleteCF(b.dataset.del));

    // totales
    const tin  = rows.filter(r=> r.type==='ingreso').reduce((a,r)=> a+Number(r.amount||0),0);
    const tout = rows.filter(r=> r.type==='gasto').reduce((a,r)=> a+Number(r.amount||0),0);
    $('#cfIncome').textContent  = cfHuman(tin);
    $('#cfExpense').textContent = cfHuman(tout);
    const bal = tin - tout; const el = $('#cfBalance');
    el.textContent = cfHuman(bal);
    el.className = 'text-2xl font-bold ' + (bal>=0?'text-emerald-700':'text-red-700');
  }
  function openCfForm(id){
    const dlg = $('#cfDialog'); const f = $('#cfForm'); f.reset();
    $('#cfDialogTitle').textContent = id ? 'Editar movimiento' : 'Nuevo movimiento';
    $('#cf_id').value = id||'';
    $('#cf_date').value = new Date().toISOString().slice(0,10);
    if(id){
      const r = CF.find(x=> x.id===id); if(r){
        $('#cf_date').value=r.date||''; $('#cf_type').value=r.type||'ingreso'; $('#cf_category').value=r.category||'';
        $('#cf_amount').value=r.amount||''; $('#cf_concept').value=r.concept||''; $('#cf_method').value=r.method||'';
        $('#cf_notes').value=r.notes||'';
      }
    }
    dlg.showModal();
  }
  function deleteCF(id){ const r = CF.find(x=> x.id===id); if(!r) return; if(!confirm(`¬øEliminar "${r.type} ¬∑ ${r.concept}"?`)) return; CF = CF.filter(x=> x.id!==id); saveCF(); renderCF(); }
  $('#btnCfAdd').onclick = ()=> openCfForm();
  $('#btnCfCancel').onclick = ()=> $('#cfDialog').close();
  $('#cfForm').onsubmit = (e)=>{
    e.preventDefault();
    const id = $('#cf_id').value || ('tx_' + Date.now().toString(36));
    const r = { id, date: $('#cf_date').value, type: $('#cf_type').value, category: $('#cf_category').value.trim(), amount: Number($('#cf_amount').value||0), concept: $('#cf_concept').value.trim(), method: $('#cf_method').value.trim(), notes: $('#cf_notes').value.trim() };
    if(!r.date || !r.type || !r.category || !r.concept || !r.amount){ alert('Completa fecha, tipo, categor√≠a, concepto y monto.'); return; }
    const i = CF.findIndex(x=> x.id===id); if(i>=0) CF[i]=r; else CF.push(r);
    saveCF(); $('#cfDialog').close(); renderCF();
  };
  $('#cfSearch').oninput = renderCF; $('#cfType').onchange = renderCF; $('#cfFrom').onchange = renderCF; $('#cfTo').onchange = renderCF;
  $('#btnCfClear').onclick = ()=>{ $('#cfSearch').value=''; $('#cfType').value=''; $('#cfFrom').value=''; $('#cfTo').value=''; renderCF(); };
  renderCF();

  /* ====== TABS ====== */
  const tabPatients=$('#tabPatients'), tabInventory=$('#tabInventory'), tabCashflow=$('#tabCashflow');
  function setTab(t){
    show($('#patientsView'), t==='patients');
    show($('#inventoryView'), t==='inventory');
    show($('#cashflowView'),  t==='cashflow');
    tabPatients.classList.toggle('tab-active', t==='patients');
    tabInventory.classList.toggle('tab-active', t==='inventory');
    tabCashflow.classList.toggle('tab-active',  t==='cashflow');
  }
  tabPatients.onclick = ()=> setTab('patients');
  tabInventory.onclick= ()=> setTab('inventory');
  tabCashflow.onclick = ()=> setTab('cashflow');
  </script>
</body>
</html>
